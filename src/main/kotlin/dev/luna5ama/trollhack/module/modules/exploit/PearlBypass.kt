package dev.luna5ama.trollhack.module.modules.exploit

import dev.luna5ama.trollhack.manager.managers.HotbarSwitchManager.ghostSwitch
import dev.luna5ama.trollhack.manager.managers.PlayerPacketManager.sendPlayerPacket
import dev.luna5ama.trollhack.module.Category
import dev.luna5ama.trollhack.module.Module
import dev.luna5ama.trollhack.module.modules.movement.AutoCenter
import dev.luna5ama.trollhack.util.inventory.slot.firstItem
import dev.luna5ama.trollhack.util.inventory.slot.hotbarSlots
import dev.luna5ama.trollhack.util.math.vector.Vec2f
import dev.luna5ama.trollhack.util.threads.runSafe
import net.minecraft.init.Items
import net.minecraft.network.play.client.CPacketPlayerTryUseItem
import net.minecraft.util.EnumHand
import net.minecraft.util.math.Vec3d

internal object PearlBypass : Module(
    name = "Pearl Bypass",
    category = Category.EXPLOIT,
    description = "2 pearls modules in one"
) {
    private val pitch by setting("Pitch", 85.0f, -90.0f..90.0f, 1.0f)
    private val smart by setting("Smart", true)
    private val autoCenter by setting("Center", true, ::smart)

    private var center: Vec3d? = null

    init {
        onEnable {
            doPearlPhase()
        }
    }

    private fun doPearlPhase() {
        runSafe {
            val player = mc.player ?: return@runSafe
            if (autoCenter) {
                center = Vec3d(player.posX, player.posY, player.posZ)
                AutoCenter.centerPlayer(center!!)
            }
            val pearlSlot = player.hotbarSlots.firstItem(Items.ENDER_PEARL)
            if (pearlSlot != null) {
                ghostSwitch(pearlSlot) {
                    sendPlayerPacket {
                        rotate(Vec2f(player.rotationYaw, pitch))
                        connection.sendPacket(CPacketPlayerTryUseItem(EnumHand.MAIN_HAND))
                    }
                }
                disable()
            }
        }
    }
}
